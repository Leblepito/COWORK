name: Deploy to Railway

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
  RAILWAY_PROJECT_ID: 78ef3a62-9691-4ece-a6cd-f5a46fb79a3b
  RAILWAY_ENV_ID: 6203d789-faaf-460e-a6eb-93e31d733ee0

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Get Railway project info
        run: |
          set -e
          echo "=== Railway whoami ==="
          railway whoami || echo "Token might be project-scoped"
          echo ""
          echo "=== Listing services ==="
          railway service list 2>&1 || true

      - name: Deploy via Railway API
        run: |
          set -e

          # Use Railway GraphQL API to trigger redeploy
          # First get services
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $RAILWAY_TOKEN" \
            -H "Content-Type: application/json" \
            "https://backboard.railway.app/graphql/v2" \
            -d "{\"query\":\"query { project(id: \\\"$RAILWAY_PROJECT_ID\\\") { name services { edges { node { id name serviceInstances { edges { node { id environmentId latestDeployment { id status } } } } } } } } }\"}")

          echo "Project info:"
          echo "$RESPONSE" | python3 -m json.tool 2>/dev/null || echo "$RESPONSE"

          # Extract service IDs and trigger redeploy for each
          echo "$RESPONSE" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          project = data.get('data', {}).get('project', {})
          print(f'Project: {project.get(\"name\", \"unknown\")}')
          services = project.get('services', {}).get('edges', [])
          for svc in services:
              node = svc['node']
              print(f'Service: {node[\"name\"]} (ID: {node[\"id\"]})')
              for inst in node.get('serviceInstances', {}).get('edges', []):
                  inst_node = inst['node']
                  env_id = inst_node.get('environmentId', '')
                  deploy = inst_node.get('latestDeployment', {})
                  print(f'  Env: {env_id} | Latest deploy: {deploy.get(\"status\", \"none\")}')
          "

      - name: Trigger redeploy for all services
        run: |
          set -e

          # Get service instance IDs for production environment
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $RAILWAY_TOKEN" \
            -H "Content-Type: application/json" \
            "https://backboard.railway.app/graphql/v2" \
            -d "{\"query\":\"query { project(id: \\\"$RAILWAY_PROJECT_ID\\\") { services { edges { node { id name serviceInstances { edges { node { id environmentId } } } } } } } }\"}")

          # Trigger redeploy for each service in production
          echo "$RESPONSE" | python3 -c "
          import subprocess, sys, json, os
          token = os.environ['RAILWAY_TOKEN']
          env_id = os.environ['RAILWAY_ENV_ID']
          data = json.load(sys.stdin)
          services = data.get('data', {}).get('project', {}).get('services', {}).get('edges', [])
          for svc in services:
              node = svc['node']
              svc_id = node['id']
              svc_name = node['name']
              for inst in node.get('serviceInstances', {}).get('edges', []):
                  if inst['node']['environmentId'] == env_id:
                      print(f'Triggering redeploy for {svc_name}...')
                      # Use serviceInstanceRedeploy mutation
                      mutation = '{\"query\":\"mutation { serviceInstanceRedeploy(environmentId: \\\\\"' + env_id + '\\\\\", serviceId: \\\\\"' + svc_id + '\\\\\") }\"}'
                      result = subprocess.run([
                          'curl', '-s', '-X', 'POST',
                          '-H', f'Authorization: Bearer {token}',
                          '-H', 'Content-Type: application/json',
                          'https://backboard.railway.app/graphql/v2',
                          '-d', mutation
                      ], capture_output=True, text=True)
                      print(f'{svc_name}: {result.stdout}')
          "
