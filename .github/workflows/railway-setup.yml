name: Railway Setup — Domain & Variables

on:
  workflow_dispatch:

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

jobs:
  setup:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Collect Railway info and configure
        run: |
          REPORT=""

          # Fix Dockerfile path — railway up runs from cd frontend,
          # so upload root IS frontend/. Path must be "Dockerfile" not "frontend/Dockerfile"
          REPORT+="## Fix RAILWAY_DOCKERFILE_PATH\n"
          FIX_PATH=$(railway variables set RAILWAY_DOCKERFILE_PATH="Dockerfile" \
            --service frontend --environment production 2>&1) || true
          REPORT+="\`\`\`\n${FIX_PATH}\n\`\`\`\n\n"

          # Ensure COWORK_API_URL is set for Railway private networking
          REPORT+="## Set COWORK_API_URL\n"
          SET_URL=$(railway variables set COWORK_API_URL="http://backend.railway.internal:8888" \
            --service frontend --environment production 2>&1) || true
          REPORT+="\`\`\`\n${SET_URL}\n\`\`\`\n\n"

          # List domains
          REPORT+="## Current Domains\n"
          DOMAINS=$(railway domain --service frontend 2>&1) || true
          REPORT+="\`\`\`\n${DOMAINS}\n\`\`\`\n\n"

          # Variables after fix
          REPORT+="## Frontend Variables\n"
          VARS=$(railway variables --service frontend --environment production 2>&1) || true
          REPORT+="\`\`\`\n${VARS}\n\`\`\`\n\n"

          # Redeploy with corrected config
          REPORT+="## Redeploy Frontend\n"
          cd frontend
          DEPLOY=$(railway up --detach --service frontend --environment production 2>&1) || true
          REPORT+="\`\`\`\n${DEPLOY}\n\`\`\`\n"

          echo -e "$REPORT" > /tmp/railway-report.md

      - name: Create GitHub issue with results
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue create \
            --repo ${{ github.repository }} \
            --title "Railway Setup — $(date -u '+%Y-%m-%d %H:%M UTC')" \
            --body-file /tmp/railway-report.md \
            || echo "Issue creation failed"
