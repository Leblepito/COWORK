name: Railway Setup — Domain & Variables

on:
  workflow_dispatch:

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

jobs:
  setup:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Collect Railway info and configure
        run: |
          REPORT=""

          # Fix Dockerfile path (was cowork-army/frontend/Dockerfile, should be frontend/Dockerfile)
          REPORT+="## Fix RAILWAY_DOCKERFILE_PATH\n"
          FIX_PATH=$(railway variables set RAILWAY_DOCKERFILE_PATH="frontend/Dockerfile" \
            --service frontend --environment production 2>&1) || true
          REPORT+="\`\`\`\n${FIX_PATH}\n\`\`\`\n\n"

          # Remove stale NEXT_PUBLIC_COWORK_API_URL (no longer needed, using middleware proxy)
          REPORT+="## Remove NEXT_PUBLIC_COWORK_API_URL\n"
          DEL_VAR=$(railway variables delete NEXT_PUBLIC_COWORK_API_URL \
            --service frontend --environment production --yes 2>&1) || true
          REPORT+="\`\`\`\n${DEL_VAR}\n\`\`\`\n\n"

          # Check Railway domain CLI usage
          REPORT+="## Railway domain help\n"
          HELP=$(railway domain --help 2>&1) || true
          REPORT+="\`\`\`\n${HELP}\n\`\`\`\n\n"

          # Try adding root domain — correct syntax
          REPORT+="## Add ireska.com\n"
          ADD1=$(railway domain ireska.com --service frontend 2>&1) || true
          REPORT+="\`\`\`\n${ADD1}\n\`\`\`\n\n"

          # Try www
          REPORT+="## Add www.ireska.com\n"
          ADD2=$(railway domain www.ireska.com --service frontend 2>&1) || true
          REPORT+="\`\`\`\n${ADD2}\n\`\`\`\n\n"

          # List domains
          REPORT+="## Current Domains\n"
          DOMAINS=$(railway domain --service frontend 2>&1) || true
          REPORT+="\`\`\`\n${DOMAINS}\n\`\`\`\n\n"

          # Variables after fix
          REPORT+="## Frontend Variables (after fix)\n"
          VARS=$(railway variables --service frontend --environment production 2>&1) || true
          REPORT+="\`\`\`\n${VARS}\n\`\`\`\n\n"

          # Redeploy with corrected Dockerfile path
          REPORT+="## Redeploy Frontend\n"
          cd frontend
          DEPLOY=$(railway up --detach --service frontend --environment production 2>&1) || true
          REPORT+="\`\`\`\n${DEPLOY}\n\`\`\`\n"

          echo -e "$REPORT" > /tmp/railway-report.md

      - name: Create GitHub issue with results
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue create \
            --repo ${{ github.repository }} \
            --title "Railway Setup v2 — $(date -u '+%Y-%m-%d %H:%M UTC')" \
            --body-file /tmp/railway-report.md \
            || echo "Issue creation failed"
