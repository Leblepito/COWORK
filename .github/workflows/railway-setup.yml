name: Railway Setup — Domain & Variables

on:
  workflow_dispatch:

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

jobs:
  setup:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Collect Railway info and configure
        id: railway
        run: |
          REPORT=""

          # Status
          REPORT+="## Railway Status\n"
          STATUS=$(railway status 2>&1) || true
          REPORT+="\`\`\`\n${STATUS}\n\`\`\`\n\n"

          # Set env var
          REPORT+="## Set COWORK_API_URL\n"
          SET_VAR=$(railway variables set COWORK_API_URL="http://backend.railway.internal:8888" \
            --service frontend --environment production 2>&1) || true
          REPORT+="\`\`\`\n${SET_VAR}\n\`\`\`\n\n"

          # List variables
          REPORT+="## Frontend Variables\n"
          VARS=$(railway variables --service frontend --environment production 2>&1) || true
          REPORT+="\`\`\`\n${VARS}\n\`\`\`\n\n"

          # Current domains
          REPORT+="## Current Domains (before)\n"
          DOMAINS_BEFORE=$(railway domain --service frontend --environment production 2>&1) || true
          REPORT+="\`\`\`\n${DOMAINS_BEFORE}\n\`\`\`\n\n"

          # Add domains
          REPORT+="## Add ireska.com\n"
          ADD1=$(railway domain add ireska.com --service frontend --environment production 2>&1) || true
          REPORT+="\`\`\`\n${ADD1}\n\`\`\`\n\n"

          REPORT+="## Add www.ireska.com\n"
          ADD2=$(railway domain add www.ireska.com --service frontend --environment production 2>&1) || true
          REPORT+="\`\`\`\n${ADD2}\n\`\`\`\n\n"

          # Domains after
          REPORT+="## Domains (after)\n"
          DOMAINS_AFTER=$(railway domain --service frontend --environment production 2>&1) || true
          REPORT+="\`\`\`\n${DOMAINS_AFTER}\n\`\`\`\n\n"

          # Backend service status
          REPORT+="## Backend Domains\n"
          BACKEND_DOMAINS=$(railway domain --service backend --environment production 2>&1) || true
          REPORT+="\`\`\`\n${BACKEND_DOMAINS}\n\`\`\`\n\n"

          # Redeploy
          REPORT+="## Redeploy Frontend\n"
          cd frontend
          DEPLOY=$(railway up --detach --service frontend --environment production 2>&1) || true
          REPORT+="\`\`\`\n${DEPLOY}\n\`\`\`\n"

          # Write to file
          echo -e "$REPORT" > /tmp/railway-report.md

      - name: Create GitHub issue with results
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue create \
            --repo ${{ github.repository }} \
            --title "Railway Setup Report — $(date -u '+%Y-%m-%d %H:%M UTC')" \
            --body-file /tmp/railway-report.md \
            --label "infra"
